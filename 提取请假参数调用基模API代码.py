import http.client
import json

prompt = """

你是一个BPM流程数据分析总结的专家，利用自己的专业知识，对于用户输入的问题，一步一步分析，最重要的是得到正确结果，输入数据说明：
接收 BPM 流程表单数据，流程的个性数据，及审批历史记录（审批人、审批时间、审批意见、审批动作，审批节点）。数据以 JSON 格式或结构化表格形式传入。
分析任务要求：
**项目核心价值**：分为3个小点：
	- 业务目标/业务痛点：从项目目标+项目（群）描述+三年投资回报率三个内容结合起来归纳总结，提炼关键信息输出，不要分开。
	- 项目等级：取项目等级里面的内容
	- 共建/协同：提取子项明细信息，分析预算编号（来源预算系统），如果存在多个预算编号（来源预算系统）则输出"是"，否则输出"否"
**预算出处**：根据子项明细信息的内容，按业务单位分组计算，通过立项金额的数据分别计算出每个业务单位的预算占比，输出业务单位和预算占比，按数组输出格式：[业务单位:占比；业务单位:占比；业务单位:占比]
**风险控制**：请使用自己的知识结合立项内容里面的投资金额+项目等级+3年投资回报率进行评估，可能存在的风险和需要注意的事项，综合输出。
**快速审批意见**：
  第一步：当项目名称包含"优化"、"迭代"、"二期"、"三期"等关键词，直接输出审批意见："在原项目基础上进行迭代开发，预算、专业性评审无异议，可直接通过。"。
  第二步：当且仅当满足以下两个条件时进入该逻辑分支，否则跳到第三步：
    1.业务能力建设项目（是否能力建设=是）
    2.当三年投资回报率大于300%的时候进入以下逻辑分支，否则跳到第三步：
      a. 当项目(群)预算(含税)>300w,控股项目等级包含"核心"或"重点"，输出："预算、目标、合规性无异议，关键干系人已会签，可直接通过"
      b. 当项目(群)预算(含税)在100万到300万,控股项目等级包含"核心"或"重点"，输出："预算、目标、专业性评审无异议，可直接通过。"
      c. 当项目(群)预算(含税)<100w,输出："预算、目标、专业性评审无异议，可直接通过。"
      d. 当项目(群)预算(含税)在30w到100w之间,输出："预算、目标、专业性评审无异议，可直接通过。"
  第三步：当且仅当满足以下两个条件时进入该逻辑分支，否则跳到第四步：
    1. 非能力建设项目（是否能力建设=否）
    2. 项目名称包含"许可"、"订阅"、"集采"、"采购"、"框架"、"咨询"等关键词
    判断逻辑：
      a. 当项目(群)预算(含税)≥300w,输出："预算、目标、合规性无异议，关键干系人已会签，可直接通过"
      b. 当项目(群)预算(含税)在100万到300万,输出："预算、目标、专业性评审无异议，可直接通过。"
      c. 当项目(群)预算(含税)<100w,输出："预算、目标、专业性评审无异议，可直接通过。"
  第四步：以上条件都不满足时，输出："项目预算、目标、专业性评审存在一定风险，请确定无误后再审批
输出示例：
项目核心价值：按业务目标/业务痛点，项目等级，共建/协同三个小点分别输出。
预算出处：按数组格式输出业务单位和占比。
风险控制: 直接输出风险内容
快速审批意见：直接输出审批意见内容
要求：
  -语言简洁凝练，关键信息突出；
  -按照,项目核心价值,预算出处,风险控制,快速审批意见四个项目转成json的形式输出
  -按要求直接输出json，不需要输出推理的过程
 -如果{{language}}等于en，上述内容都翻译成英文输出。

"""
problem = "输入：我的流程数据：{\"基础信息\":{\"流程主题\":\"2025-05-15-法务-案件项目-张亚彬-立项\",\"项目名称\":\"法务-案件项目\",\"项目编号\":\"GHXX20250007\",\"申请人\":\"张亚彬（Yabin.Zhang2）\",\"申请类型\":\"立项\",\"是否涉及合规\":\"否\",\"项目(群)预算(含税)\":\"120.55 万元\",\"预算大写\":\"人民币壹佰贰拾万伍仟伍佰元整\",\"业务项目经理\":\"耿昕（Xin.Geng1）\",\"IT项目经理\":\"吴芝荟（e-Zhihui.Wu）\",\"控股项目等级\":\"集团级重要项目\",\"是否能力建设\":\"是\",\"项目（群）描述\":\"【项目背景】：\\n随着法律科技的发展，业务管理层期望快速推进法务领域AI应用场景落地，实现提效降本、扩展线下沟通记录等证据获取方式，实现案件全生命周期管理，为法务赋能，促进内部流程规范化，完善诉讼流程风险管理。\\n【项目范围】：\\n案件AI能力建设-法律问答、法律法规及类案检索推送、文书起草、智能阅卷、案件分析；\\n证据获取提效-首期先对接企业微信、邮箱自动获取业务往来等沟通记录，规避人员离职导致证据获取难的风险；\\n风险排查-对接天眼查实现吉利旗下核心主体及高管所任职的内部企业被诉案件自动排查，增加已申报案件开庭提醒频次及通知范围。\",\"项目（群）目标\":\"1、办案成本节约7.7人年，降本154万/年； 2、证据获取提效11.5人年，约230.8万/年； 3、瞒报排查风控价值100万/年。\",\"三年投资回报率\":\"12%\",\"投资回报分析\":\"首年投入120.55万，总价值484.8万，投入产出比4.02。随着法律科技的发展，能力成长期（第2-3年）年价值1446.1万，收获期（第4-5年）年价值1953.9万。\"},\"子项明细\":[{\"预算编号（来源预算系统）\":\"YS25-29528\",\"预算类型\":\"外采预算\",\"立项金额(万元）\":\"120.55\",\"剩余可用预算（万元）\":\"116.04\",\"业务单位\":\"数字化中心\",\"业务领域\":\"AI技术\"}],\"里程碑信息\":[{\"column0\":\"\",\"名称\":\"项目启动\",\"计划日期\":\"2025-05-13\"},{\"column0\":\"\",\"名称\":\"蓝图设计\",\"计划日期\":\"2025-06-10\"},{\"column0\":\"\",\"名称\":\"能力目标实现\",\"计划日期\":\"\"},{\"column0\":\"\",\"名称\":\"项目验收\",\"计划日期\":\"2026-03-30\"}],\"项目所属信息\":[{\"所属单位\":\"控股集团\",\"所属部门\":\"数字化中心\"}],\"专业评审信息\":[{\"类型\":\"专业组评审结论\",\"结论\":\"评审人：章正柱，钱文家，耿昕，吴芝荟，孟罗茜，张亚彬\\n评审内容：\\n瞒报排查：聚焦核心主体，做好核心主体清单更新；\\n智能问数：要关注实现方式、成本，可以把AI团队已有能力移植到千律。\\n证据获取：可先做企业微信、邮箱。系统对接以招标、合同、财务系统为主，业务系统上千套对接成本太高。\\n同行标杆企业建设方案：可以利用供应商资源了解汽车行业典型企业目前的解决方案。比亚迪是自研的，案件系统供应商有不少新能源汽车客户\\n评审结论：通过\"},{\"类型\":\"信息安全评审结论\",\"结论\":\"评审人：刘磊\\n评审内容：方案确认，该立项在4月初已拉会评估，采用本地化部署方式，不提供外网访问入口。另，系统自身的信息安全策略已同步给PM，待系统上线前在通过安全技术扫描进行检验。\\n评审结论：通过\"},{\"类型\":\"数据合规评审结论\",\"结论\":\"不涉及\"}],\"附件列表\":[{\"文件类型\":\"立项材料\",\"文件\":\"案件管理系统升级立项报告0508立项汇报终稿.pptx\",\"创建时间\":\"2025-05-15 16:08:00\"},{\"文件类型\":\"项目预算明细\",\"文件\":\"详细预算表-案件.xlsx\",\"创建时间\":\"2025-05-15 16:34:05\"},{\"文件类型\":\"会议纪要\",\"文件\":\"会议纪要.png\",\"创建时间\":\"2025-05-15 16:34:05\"},{\"文件类型\":\"信息安全评审依据\",\"文件\":\"信息安全评估.png\",\"创建时间\":\"2025-05-15 16:34:05\"},{\"文件类型\":\"其他\",\"文件\":\"\",\"创建时间\":\"2025-05-15 16:34:05\"}],\"审批历史\":[{\"审批动作\":\"开始\",\"审批节点\":\"开始\",\"审批人\":\"张亚彬\",\"审批时间\":\"2025-05-15 17:11:48\",\"审批意见\":\"提交\"},{\"审批动作\":\"ITTeam\",\"审批节点\":\"IT体系\",\"审批人\":\"钱文家\",\"审批时间\":\"2025-05-15 17:15:03\",\"审批意见\":\"同意！已完成内部评审\"},{\"审批动作\":\"ITTeam\",\"审批节点\":\"IT体系\",\"审批人\":\"潘焱驹\",\"审批时间\":\"2025-05-15 17:37:42\",\"审批意见\":\"同意！\"},{\"审批动作\":\"ITTeam\",\"审批节点\":\"IT体系\",\"审批人\":\"潘焱驹\",\"审批时间\":\"2025-05-15 17:37:44\",\"审批意见\":\"同意！\"},{\"审批动作\":\"ITTeam\",\"审批节点\":\"IT体系\",\"审批人\":\"张小晚\",\"审批时间\":\"2025-05-15 17:39:54\",\"审批意见\":\"同意！\"},{\"审批动作\":\"ITTeam\",\"审批节点\":\"IT体系\",\"审批人\":\"陈雪飞\",\"审批时间\":\"2025-05-15 17:42:42\",\"审批意见\":\"同意！\"},{\"审批动作\":\"ITTeam\",\"审批节点\":\"IT体系\",\"审批人\":\"刘磊\",\"审批时间\":\"2025-05-16 10:08:29\",\"审批意见\":\"同意！\"},{\"审批动作\":\"BusinessAudit\",\"审批节点\":\"业务审核\",\"审批人\":\"张伟丽\",\"审批时间\":\"2025-05-16 10:27:58\",\"审批意见\":\"会签:耿昕(Xin Geng);董臻静(christine Dong),备注:先审核\"},{\"审批动作\":\"FinancialAudit\",\"审批节点\":\"财务审核\",\"审批人\":\"何雅之\",\"审批时间\":\"2025-05-16 10:40:27\",\"审批意见\":\"同意！在数字化年度预算范围内，预计投入120.55万（含内部人天投入33万），预计通过降本和提效等实现首年价值回报484.8万。\"},{\"审批动作\":\"BusinessAudit\",\"审批节点\":\"业务审核\",\"审批人\":\"耿昕\",\"审批时间\":\"2025-05-16 11:30:41\",\"审批意见\":\"同意！\"},{\"审批动作\":\"FinancialAudit\",\"审批节点\":\"财务审核\",\"审批人\":\"余滢洁\",\"审批时间\":\"2025-05-16 13:09:29\",\"审批意见\":\"同意！\"},{\"审批动作\":\"BusinessAudit\",\"审批节点\":\"业务审核\",\"审批人\":\"董臻静\",\"审批时间\":\"2025-05-16 13:38:02\",\"审批意见\":\"同意！\"},{\"审批动作\":\"DigitalAudit\",\"审批节点\":\"数字化审核\",\"审批人\":\"章正柱\",\"审批时间\":\"2025-05-16 14:33:06\",\"审批意见\":\"同意！\"},{\"审批动作\":\"BusinessAudit\",\"审批节点\":\"业务审核\",\"审批人\":\"张伟丽\",\"审批时间\":\"2025-05-16 15:53:25\",\"审批意见\":\"同意！\"},{\"审批动作\":\"BusinessAudit\",\"审批节点\":\"业务审核\",\"审批人\":\"姚滨晖\",\"审批时间\":\"2025-05-16 23:03:13\",\"审批意见\":\"同意！\"},{\"审批动作\":\"结束\",\"审批节点\":\"结束\",\"审批人\":\"\",\"审批时间\":\"2025-05-16 23:03:21\",\"审批意见\":\"结束\"}]}，请帮我分析一下流程数据."

conn = http.client.HTTPSConnection("model-svc.geely-test.com")
payload = json.dumps({
    "model": "deepseek-v3",
    "temperature": 0.0001,
    "top_p": 0.0001,
    "messages": [
        {
            "role": "user",
            "content": problem

        },
        {
            "role": "system",
            "content": prompt

        }
    ],
    "stream": True,
    "stream_options": {
        "include_usage": True
    }
})
headers = {
    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
    'Content-Type': 'application/json',
    'Accept': '*/*',
    'Host': 'model-svc.geely-test.com',
    'Connection': 'keep-alive'
}
conn.request("POST", "/vllm/deepseek-v3/v1/chat/completions", payload, headers)
res = conn.getresponse()

# 初始化一个空字符串来存储所有delta.content的内容
full_content = ""

# 逐行读取响应数据
for line in res:
    line = line.decode("utf-8").strip()
    if line.startswith("data: "):
        data_str = line[6:]  # 移除"data: "前缀
        if data_str == "[DONE]":
            break
        
        try:
            data = json.loads(data_str)
            # 检查是否有choices且choices不为空
            if "choices" in data and len(data["choices"]) > 0:
                choice = data["choices"][0]
                # 检查delta中是否有content字段
                if "delta" in choice and "content" in choice["delta"]:
                    full_content += choice["delta"]["content"]
        except json.JSONDecodeError:
            print(f"Error decoding JSON: {data_str}")

# 打印完整内容
print(full_content)